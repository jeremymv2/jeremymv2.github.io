<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chef Compliance Office Hour</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content=""The brief, calm period between a rising and falling tide."  Here I try a hand at pragmatic ramblings about things such as computering, sailing and whatever else.">
    <link rel="canonical" href="https://jeremymv2.github.io/compliance/2016/12/05/compliance_office_hour/">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
    <body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
     <!-- Navigation -->
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
        <div class="container">
             <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand page-scroll" href="/">
                    <i class="fa fa-play-circle"></i>  <span class="light">Reset</span>
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
                <ul class="nav navbar-nav">
                    <!-- Hidden li included to remove active class from about link when scrolled up past about section -->
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#articles">Articles</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

        <!-- Intro Header -->
    <header class="intro">
        <div class="intro-body">
            <div class="container">
                <div class="row">
                    <div class="col-md-8 col-md-offset-2">
                        <h1 class="brand-heading">Slack Tide</h1>
                        <p class="intro-text">"The brief, calm period between a rising and falling tide."  Here I try a hand at pragmatic ramblings about things such as computering, sailing and whatever else.<br>
                        <a href="#articles" class="btn btn-circle page-scroll">
                            <i class="fa fa-angle-double-down animated"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

        <!-- About Section -->
    <section id="articles" class="container content-section text-center">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2>Articles</h2>
  
    <p>
      <a href="/compliance/2016/12/05/compliance_office_hour//#article-content">Chef Compliance Office Hour&nbsp;-&nbsp;December 05, 2016</a>
    </p>
  
            </div>
        </div>

    </section>
  <section id="article-content" class="container content-section"
    <div class="row">
    <article class="post-content">
      <h1 id="chef-compliance-demo--office-hour">Chef Compliance demo &amp; office hour</h1>
<p>Demo some latest and greatest Chef Compliance things!</p>

<h1 id="audit-cookbook-updates">Audit Cookbook updates</h1>

<p>Initially the audit cookbook supported reporting 3 ways:</p>
<ul>
  <li>Directly to Compliance</li>
  <li>To Compliance via Chef Server + Compliance integration</li>
  <li>Directly to Visibility</li>
</ul>

<p>Some recent reporting additions:</p>
<ul>
  <li>moved from converge phase to running as report handler (NEW!)</li>
  <li>json file (NEW!)</li>
  <li>Multiple reporting endpoints (NEW!)</li>
  <li>fetch profiles from Automate and report to Visibility through Chef Server proxy, without any changes to <code class="highlighter-rouge">client.rb</code> (NEW!)</li>
</ul>

<h1 id="store-profiles-in-automate">Store profiles in Automate</h1>
<p>There is now an option to store Inspec profiles via a new asset store in Automate!
Version Requirement:</p>
<ul>
  <li>automate 0.6.6</li>
</ul>

<h1 id="using-the-automate-asset-store">Using the Automate asset store</h1>

<h2 id="enable-the-feature-in-automate">Enable the feature in Automate</h2>
<p>To enable profile asset storage:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># delivery.rb
compliance_profiles['enable'] = true
</code></pre>
</div>

<h2 id="inspec-cli">inspec cli</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>$ inspec compliance help
# this is using the --dctoken (data collector token from chef-server.rb)
$ inspec compliance login_automate https://automate-server.test --insecure true --user admin --dctoken 93a49a4f2482c64126f7b6015e6b0f30284287ee4054ff8807fb63d9cbd1c506 --ent brewinc
# this is using the --usertoken (Automate user token)
$ inspec compliance login_automate https://automate-server.test --insecure true --user admin --usertoken 30284287ee4054ff8807fb63d9cbd1c506= --ent brewinc
$ inspec compliance upload /Users/jmiller/Devel/compliance-profiles/ssh.tar.gz
</code></pre>
</div>

<p>Full example:
https://gist.github.com/jeremymv2/cb34e6dfcad040b1cad50636d256b44e</p>

<h2 id="automate-api">Automate API</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>$ curl -X POST "https://automate-server.test/compliance/profiles/jmiller" \
-H "chef-delivery-enterprise: brewinc" -H "chef-delivery-user: jmiller" \
-H "chef-delivery-token: tzwlbWMtgBC0lo6sxkAYKSShxSJEohnU7IAE4NCUGCg=" \
--form "file=@/Users/jmiller/Devel/compliance-profiles/ssh.tar.gz" -k -D -

HTTP/1.1 100 Continue

HTTP/1.1 200 OK
Server: openresty
Date: Mon, 05 Dec 2016 17:52:30 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 0
Connection: keep-alive
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, X-Requested-With
Access-Control-Allow-Methods: POST, GET, OPTIONS, PUT, DELETE, PATCH
Access-Control-Allow-Origin:
</code></pre>
</div>

<p>Full example:
https://gist.github.com/jeremymv2/a1cf41bbd2d3a5250e3cf97131efa1a5</p>

<h1 id="thoughts-on-compliance-server">Thoughts on Compliance Server</h1>
<p>Question: &#8220;With the advent of Automate Compliance profile storage, why even bother with Chef Compliance server?&#8221;</p>

<p>Answer: &#8220;At the moment, the Compliance server is the only option with a UI for managing profiles and running remote ssh scans for non-chef clients.  However, the Automate Compliance Profile UI will be added soon as well as other functionality, so Chef Compliance would be a better choice only for non-Chef ecosystems.&#8221;</p>

<h1 id="testing-out-the-new">Testing out the NEW</h1>
<p>Let&#8217;s examine what it takes to run inspec scan of a node migrating</p>

<p>From this:</p>
<ul>
  <li>Audit Cookbook 2.x</li>
  <li>Profiles Stored on Compliance Server</li>
  <li>Reports sent directly to Visibility (requires client.rb settings for <code class="highlighter-rouge">data_collector</code>)</li>
</ul>

<p>To this:</p>
<ul>
  <li>Audit Cookbook 2.x</li>
  <li>Profiles Stored in Automate (Requires &gt;= 0.6.6)</li>
  <li>Inspec Scan Reports + Converge data sent to Visibility with <em>NO</em> client.rb <code class="highlighter-rouge">data_collector</code> settings required (requires Chef Client &gt;= 12.16.42 and Chef Server &gt;= 12.11.0)</li>
</ul>

<p><strong>Assumption:</strong> &#8216;linux&#8217; and &#8216;ssh&#8217; profiles have been uploaded to Automate under user &#8216;jmiller&#8217; per example above.</p>

<p>We will define our Audit profile settings via a cookbook wrapper of the <code class="highlighter-rouge">audit</code> cookbook, called <code class="highlighter-rouge">audit_wrapper</code></p>

<p>DEPRECATION WARNING:
If you&#8217;re still using version Audit Cookbook 1.x
you may have something like:</p>
<div class="highlighter-rouge"><pre class="highlight"><code># wrapper cookbook
default['audit']['collector'] = 'chef-visibility'
default['audit']['server'] = 'https://compliance-server.test/api'
default['audit']['refresh_token'] = '2/-YL_ht4owKI1WzczoDDXNhluoZl9Va8nEHpQyBF0w7OFCIa__RZ5vYrcfe5TB_ypycUeFN7BNVhs_4A5HgSvAw=='
default['audit']['profiles'] =
  {
    'base/linux' =&gt; true
  }
</code></pre>
</div>

<h2 id="reporting-with-data_collector-defined-in-clientrb">Reporting with data_collector defined in client.rb</h2>
<p>The <code class="highlighter-rouge">fetcher</code> attribute was introduced in Audit 2.0.0
Also, in 2.x <code class="highlighter-rouge">profiles</code> are now an array of hashes</p>

<p>The attributes below will fetch profiles via Compliance Server, post reports to Visibility and requires the Chef Server Integration with Compliance Server</p>
<div class="highlighter-rouge"><pre class="highlight"><code># wrapper cookbook
default['audit']['collector'] = 'chef-visibility'
default['audit']['fetcher'] = 'chef-server'
default['audit']['profiles'] = [
  {
    'name' =&gt; 'linux',
    'compliance' =&gt; 'base/linux'
  }
]
</code></pre>
</div>

<p>In the scenario above, the client node MUST be configured
with the data_collector for ingesting data into Automate</p>
<div class="highlighter-rouge"><pre class="highlight"><code># client.rb
data_collector['server_url'] = 'https://automate-server.test/data-collector/v0/'
data_collector['token'] = '93a49a4f2482c64126f7b6015e6b0f30284287ee4054ff8807fb63d9cbd1c506'
...
</code></pre>
</div>

<h2 id="no-more-data_collector-in-clientrb">No more data_collector in client.rb!</h2>

<p>In this scenario, the audit cookbook now requires minimum attribute settings. The configuration below will fetch profiles from Automate and report through the Chef Server, without requiring any <code class="highlighter-rouge">data_collector</code> settings in the client.rb</p>

<div class="highlighter-rouge"><pre class="highlight"><code># wrapper cookbook
default['audit']['collector'] = 'chef-server-visibility'
default['audit']['profiles'] = [
  {
    'name' =&gt; 'linux',
    'compliance' =&gt; 'jmiller/linux'
  }
]
</code></pre>
</div>

<p>No more client side <code class="highlighter-rouge">data_collector</code> settings to manage!</p>

<div class="highlighter-rouge"><pre class="highlight"><code># client.rb
# data_collector['server_url'] = 'https://automate-server.test/data-collector/v0/'
# data_collector['token'] = '93a49a4f2482c64126f7b6015e6b0f30284287ee4054ff8807fb63d9cbd1c506'
</code></pre>
</div>

<p>However, you must configure the Chef Server.  <strong>Note:</strong> <code class="highlighter-rouge">root_url</code> is used on Chef Server, not <code class="highlighter-rouge">server_url</code> (which is used on client side in client.rb) <strong>Note:</strong> You MUST specify both the <code class="highlighter-rouge">root_url</code> AND <code class="highlighter-rouge">token</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># chef-server.rb
data_collector['root_url'] = 'https://automate-server.test/data-collector/v0/'
data_collector['token'] = '93a49a4f2482c64126f7b6015e6b0f30284287ee4054ff8807fb63d9cbd1c506'
profiles['root_url'] = 'https://automate-server.test'
</code></pre>
</div>

<h1 id="meta-profiles">Meta Profiles</h1>
<p>Reference: http://lollyrock.com/articles/chef-compliance-meta-profiles/</p>

<p>Meta profiles are out! A meta profile is an overlay or a collection of multiple profiles.</p>

<p>Some Uses-cases are:</p>
<ul>
  <li>a deviation from CIS benchmarks</li>
  <li>collection of all CIS profiles that apply to your infrastructure (eg. a company-wide profile)</li>
</ul>

<p>A meta profile contains all its dependencies as vendored/bundled profiles so that it can run inside an Air Gapped
Environment without requirement for Internet access.</p>

<p>An example (https://github.com/chris-rock/acme-inspec-profile):</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ cat acme-inspec-profile/inspec.yml
name: acme-inspec-profile
title: Meta profile for Acme Inc
maintainer: Christoph Hartmann
copyright: Christoph Hartmann
copyright_email: chris@lollyrock.com
license: Apache 2.0
summary: This profile collects all compliance and security related requirements for Acme Inc.
version: 0.1.0
depends:
  - name: linux-patch-benchmark
    git: https://github.com/dev-sec/linux-patch-benchmark.git
  - name: windows-patch-benchmark
    git: https://github.com/dev-sec/windows-patch-benchmark.git
  - name: os-hardening
    git: https://github.com/dev-sec/tests-os-hardening.git
  - name: ssh-hardening
    git: https://github.com/dev-sec/tests-ssh-hardening.git
  - name: ssl-benchmark
    git: https://github.com/dev-sec/ssl-benchmark.git
</code></pre>
</div>

<p>Dependency locks:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ cat acme-inspec-profile/inspec.lock
---
lockfile_version: 1
depends:
- name: linux-patch-benchmark
  resolved_source:
    git: https://github.com/dev-sec/linux-patch-benchmark.git
    ref: d53030317b711f36fa2fde9e18170ce6b4eaacf2
  version_constraints: "&gt;= 0"
- name: windows-patch-benchmark
  resolved_source:
    git: https://github.com/dev-sec/windows-patch-benchmark.git
    ref: c183d08eb25638e7f5eac97e521640ea314c8e3d
  version_constraints: "&gt;= 0"
- name: os-hardening
  resolved_source:
    git: https://github.com/dev-sec/tests-os-hardening.git
    ref: da3a1b6ce8a845d6818152a824e123c2445c355f
  version_constraints: "&gt;= 0"
- name: ssh-hardening
  resolved_source:
    git: https://github.com/dev-sec/tests-ssh-hardening.git
    ref: 75754b9b3fe45c601f0fa0036b01c61c8b8e26d9
  version_constraints: "&gt;= 0"
- name: ssl-benchmark
  resolved_source:
    git: https://github.com/dev-sec/ssl-benchmark.git
    ref: e17486c864434c818f96ca13edd2c5a420100a45
  version_constraints: "&gt;= 0"
</code></pre>
</div>

<p>Example controls:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ cat acme-inspec-profile/controls/example.rb
# encoding: utf-8
# copyright: 2015, The Authors
# license: All rights reserved

# import full profile
include_controls 'hardening/ssh-hardening'

# select only individual controls
include_controls 'ssl-benchmark' do
  control "tls1.2"
end

# inspec knows that it cannot run Windows tests on Linux
include_controls 'windows-patch-benchmark'
</code></pre>
</div>

<h2 id="additional-resources">Additional Resources</h2>
<ul>
  <li>managing Chef Client client.rb settings: https://github.com/chef-cookbooks/chef-client</li>
  <li>upgrading Chef Client: https://github.com/chef-cookbooks/omnibus_updater</li>
</ul>


    </article>
      </div>
  </section>

        <!-- Contact Section -->
    <section id="contact" class="container content-section text-center">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2>Contact</h2>
                <p>Although I currently work for Chef Software as a Success Engineer, all of the words and opinions on this site are completely my own and not my employer's.</p>
                <p><a href="mailto:jeremymv2@gmail.com">jeremymv2@gmail.com</a>
                </p>
                <ul class="list-inline banner-social-buttons">
                    
                    <li>
                        <a href="https://github.com/jeremymv2" class="btn btn-default btn-lg"><i class="fa fa-github fa-fw"></i> <span class="network-name">github</span></a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </section>

        <!-- Map Section -->
    <div id="map"></div>

        <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p>Copyright &copy; Slack Tide 2017</p>
        </div>
    </footer>

     <!-- jQuery Version 1.11.0 -->
    <script src="/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="/js/jquery.easing.min.js"></script>

    <!-- Google Maps API Key - Use your own API key to enable the map feature. More information on the Google Maps API can be found at https://developers.google.com/maps/ -->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRngKslUGJTlibkQ3FkfTxj3Xss1UlZDA&sensor=false"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/js/grayscale.js"></script>
    </body>
</html>
